<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Sale - JELVIN POS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css      ">
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #0f172a;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --light: #f8fafc;
      --dark: #0f172a;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-600: #475569;
      --card-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: white;
      padding: 1.5rem 2.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo h1 {
      font-weight: 800;
      font-size: 1.75rem;
      letter-spacing: -0.025em;
    }

    .live-time {
      font-size: 1.125rem;
      opacity: 0.9;
      font-weight: 500;
    }

    .back-btn {
      background: rgba(255,255,255,0.15);
      color: white;
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-2px);
    }

    .container {
      max-width: 1600px;
      margin: 2.5rem auto;
      padding: 0 1.5rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
      letter-spacing: -0.025em;
    }

    .page-header p {
      color: var(--gray-600);
      font-size: 1.125rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .sales-layout {
      display: grid;
      grid-template-columns: 1fr 450px;
      gap: 2rem;
    }

    @media (max-width: 1200px) {
      .sales-layout {
        grid-template-columns: 1fr;
      }
    }

    .search-section {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: var(--card-shadow);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
      padding-bottom: 1.25rem;
      border-bottom: 2px solid var(--gray-100);
    }

    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    .search-box {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-box input {
      width: 100%;
      padding: 1rem 1rem 1rem 3.5rem;
      border: 2px solid var(--gray-200);
      border-radius: 1.25rem;
      font-size: 1.125rem;
      transition: var(--transition);
      background: white;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 1.25rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-600);
      font-size: 1.25rem;
    }

    .filter-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--gray-200);
      background: white;
      border-radius: 1rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: var(--transition);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-color: var(--primary);
    }

    .filter-btn:hover:not(.active) {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Search Results */
    .search-results {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1.5rem;
    }

    .search-result {
      background: var(--gray-100);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: var(--transition);
      border-left: 4px solid var(--primary);
    }

    .search-result:hover {
      background: var(--gray-200);
      transform: translateY(-2px);
      border-left-color: var(--accent);
    }

    .result-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .result-price {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-200);
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 0.875rem;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .detail-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--dark);
    }

    .stock-low .detail-value {
      color: var(--danger);
      font-weight: 700;
    }

    .cart-section {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      height: fit-content;
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.25rem;
      border-bottom: 2px solid var(--gray-100);
    }

    .cart-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    .cart-count {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: 1rem;
      font-size: 1rem;
      font-weight: 700;
    }

    .cart-items {
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
      margin-bottom: 1rem;
    }

    .cart-item {
      background: var(--gray-100);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      position: relative;
    }

    .item-name {
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--dark);
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .qty-btn {
      width: 32px;
      height: 32px;
      background: var(--light);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .qty-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .qty-input {
      width: 60px;
      padding: 0.5rem;
      text-align: center;
      border: 2px solid var(--gray-200);
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
    }

    .qty-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .item-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
    }

    .detail-label {
      color: var(--gray-600);
    }

    .detail-value {
      font-weight: 600;
      color: var(--dark);
    }

    .remove-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--light);
      color: var(--danger);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .remove-btn:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    .discount-section {
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .discount-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .discount-title {
      font-weight: 700;
      color: #b45309;
      font-size: 1.1rem;
    }

    .apply-discount-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .discount-inputs {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
    }

    .discount-input {
      padding: 0.6rem;
      border: 2px solid var(--gray-200);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .discount-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .customer-section {
      background: #f0f7ff;
      border: 1px solid #bfdbfe;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .customer-title {
      font-weight: 700;
      color: #1d4ed8;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .customer-input {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid var(--gray-200);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .customer-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .total-section {
      background: linear-gradient(135deg, #dcfce7, #f0fdf4);
      padding: 1.5rem;
      border-radius: 1.25rem;
      margin: 1.5rem 0;
      text-align: center;
      border: 2px solid #bbf7d0;
    }

    .total-label {
      font-size: 1.25rem;
      color: #166534;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .total-amount {
      font-size: 2.5rem;
      font-weight: 800;
      color: #16a34a;
      background: linear-gradient(135deg, #16a34a, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .payment-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .pay-btn {
      padding: 1.25rem;
      border: none;
      border-radius: 1.25rem;
      color: white;
      font-weight: 700;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      transition: var(--transition);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }

    .pay-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

    .btn-cash { 
      background: linear-gradient(135deg, #10b981, #047857); 
    }
    .btn-momo { 
      background: linear-gradient(135deg, #0d9488, #0f766e); 
    }
    .btn-card { 
      background: linear-gradient(135deg, #ea580c, #c2410c); 
    }

    .no-results {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--gray-600);
      font-style: italic;
      font-size: 1.125rem;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    @media (max-width: 768px) {
      .header { padding: 1.25rem 1.5rem; }
      .logo h1 { font-size: 1.5rem; }
      .live-time { font-size: 1rem; }
      .container { margin: 1.5rem auto; padding: 0 1rem; }
      .page-header h1 { font-size: 2rem; }
      .result-name { font-size: 1.125rem; }
      .result-price { font-size: 1.25rem; }
      .pay-btn { font-size: 1.125rem; padding: 1rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <i class="fas fa-cash-register"></i>
      <h1>New Sale</h1>
    </div>
    <div class="live-time" id="liveTime">Loading...</div>
    <a href="dashboard.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Dashboard
    </a>
  </div>

  <div class="container">
    <div class="page-header">
      <h1><i class="fas fa-shopping-cart"></i> Point of Sale</h1>
      <p>Add products to cart and process payments seamlessly</p>
    </div>

    <div class="sales-layout">
      <div class="search-section">
        <div class="section-header">
          <i class="fas fa-search"></i>
          <h2>Find Product</h2>
        </div>
        
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchInput" placeholder="Search products..." oninput="searchProducts()">
        </div>
        
        <div class="filter-buttons">
          <button class="filter-btn active" onclick="setProductFilter('all')">All Products</button>
          <button class="filter-btn" onclick="setProductFilter('in')">In Stock</button>
          <button class="filter-btn" onclick="setProductFilter('low')">Low Stock</button>
        </div>
        
        <div class="search-results" id="searchResults">
          <!-- Search results loaded here -->
          <div class="no-results">Start typing to find products...</div>
        </div>
      </div>

      <div class="cart-section">
        <div class="cart-header">
          <div class="cart-title">🛒 Your Cart</div>
          <div class="cart-count" id="cartCount">0 items</div>
        </div>
        
        <div class="cart-items" id="cartItems">
          <!-- Cart items loaded here -->
          <div class="no-results">Add products to your cart</div>
        </div>

        <!-- Customer Phone Section -->
        <div class="customer-section">
          <div class="customer-title">Customer Phone (Optional)</div>
          <input type="tel" id="customerPhone" class="customer-input" placeholder="e.g., 0241234567">
        </div>

        <!-- Discount Section -->
        <div class="discount-section">
          <div class="discount-header">
            <div class="discount-title">Apply Discount</div>
            <button class="apply-discount-btn" onclick="applyDiscount()">Apply</button>
          </div>
          <div class="discount-inputs">
            <input type="number" id="discountValue" class="discount-input" placeholder="0" min="0">
            <select id="discountType" class="discount-input">
              <option value="percent">%</option>
              <option value="fixed">₵</option>
            </select>
          </div>
        </div>
        
        <div class="total-section">
          <div class="total-label">TOTAL TO PAY</div>
          <div class="total-amount"><span id="currencySymbol">₵</span><span id="total">0.00</span></div>
        </div>
        
        <div class="payment-buttons">
          <button class="pay-btn btn-cash" onclick="processPayment('Cash')">
            <i class="fas fa-money-bill-wave"></i> Cash Payment
          </button>
          <button class="pay-btn btn-momo" onclick="processPayment('MoMo')">
            <i class="fas fa-mobile-alt"></i> MoMo Payment
          </button>
          <button class="pay-btn btn-card" onclick="processPayment('Card')">
            <i class="fas fa-credit-card"></i> Card Payment
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // UNIVERSAL SESSION VALIDATION
    function validateSession() {
      const currentShopId = sessionStorage.getItem('currentShopId');
      const currentUserRole = sessionStorage.getItem('currentUserRole');
      const currentUserEmail = sessionStorage.getItem('currentUserEmail');
      const currentCurrency = sessionStorage.getItem('currentCurrency');
      
      if (!currentShopId || !currentUserRole || !currentUserEmail || !currentCurrency) {
        alert('Please log in first.');
        window.location.href = 'index.html';
        return false;
      }
      
      const shopData = JSON.parse(localStorage.getItem(currentShopId));
      if (!shopData) {
        alert('Shop data not found. Please log in again.');
        sessionStorage.clear();
        window.location.href = 'index.html';
        return false;
      }
      
      window.currentShopId = currentShopId;
      window.currentUserRole = currentUserRole;
      window.currentUserEmail = currentUserEmail;
      window.currentCurrency = currentCurrency;
      window.shopData = shopData;
      
      return true;
    }
    
    function saveShopData() {
      localStorage.setItem(window.currentShopId, JSON.stringify(window.shopData));
    }
    
    function getCurrencySymbol() {
      return window.currentCurrency || '₵';
    }
    
    function addAuditLog(user, action, itemType, itemName, details) {
      const auditLog = window.shopData.auditLog || [];
      
      auditLog.push({
        timestamp: new Date().toISOString(),
        user: user,
        action: action,
        itemType: itemType,
        itemName: itemName,
        details: details,
        ipAddress: '127.0.0.1'
      });
      
      window.shopData.auditLog = auditLog;
      saveShopData();
    }
    
    if (!validateSession()) {
      throw new Error('Session validation failed');
    }

    // Live time (Accra)
    function updateClock() {
      const now = new Date();
      const options = { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        timeZone: 'Africa/Accra'
      };
      document.getElementById('liveTime').innerText = now.toLocaleString('en-GB', options);
    }
    setInterval(updateClock, 1000);
    updateClock();

    let cart = [];
    let currentFilter = 'all';
    let inventory = window.shopData.inventory || [];
    let appliedDiscount = null; // { type: 'percent' or 'fixed', value: number }

    // ===========================
    // 🔥 LIVE VIEW FEATURE ADDED BELOW
    // ===========================

    // Add a unique key for this cashier's live cart
    const liveCartKey = window.currentUserEmail;

    // Update live cart every 10 seconds
    setInterval(() => {
      updateLiveCart();
    }, 10000);

    // Function to update live cart for admin monitoring
    function updateLiveCart() {
      const liveCart = window.shopData.liveCart || {};
      liveCart[liveCartKey] = {
        cashier: window.currentUserEmail,
        items: cart.map(item => ({
          name: item.name,
          qty: item.qty,
          price: item.basePrice / (item.packSize || 1),
          unit: item.unit
        })),
        total: calculateSubtotal(),
        timestamp: new Date().toISOString()
      };
      window.shopData.liveCart = liveCart;
      saveShopData();
    }

    // ===========================
    // 🔥 END OF LIVE VIEW FEATURE
    // ===========================

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search products
    function searchProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const resultsDiv = document.getElementById('searchResults');
      
      if (!searchTerm) {
        resultsDiv.innerHTML = '<div class="no-results">Start typing to find products...</div>';
        return;
      }
      
      const filtered = inventory.filter(item => {
        const matchesSearch = item.name.toLowerCase().includes(searchTerm);
        if (currentFilter === 'all') return matchesSearch && item.stock > 0;
        if (currentFilter === 'in') return matchesSearch && item.stock > 0;
        if (currentFilter === 'low') {
          const totalUnits = item.unit === 'pcs' ? item.stock : (item.stock * (item.packSize || 1));
          return matchesSearch && totalUnits > 0 && totalUnits < 5;
        }
        return matchesSearch && item.stock > 0;
      });
      
      if (filtered.length === 0) {
        resultsDiv.innerHTML = `<div class="no-results">No products found. Try a different search.</div>`;
        return;
      }
      
      resultsDiv.innerHTML = filtered.map((item, index) => {
        const totalUnits = item.unit === 'pcs' ? item.stock : (item.stock * (item.packSize || 1));
        const isLow = totalUnits < 5;
        const stockDisplay = item.unit === 'pcs' ? `${item.stock} pcs` : `${item.stock} ${item.unit}`;
        const costPerUnit = item.costPrice / (item.packSize || 1);
        const profitMargin = ((item.price - costPerUnit) / costPerUnit * 100).toFixed(1);
        
        return `
          <div class="search-result" onclick="addToCart(${index})">
            <div class="result-name">${escapeHtml(item.name)}</div>
            <div class="result-price">${getCurrencySymbol()}${item.price.toFixed(2)} /unit</div>
            
            <div class="result-details">
              <div class="detail-item">
                <div class="detail-label">Stock</div>
                <div class="detail-value ${isLow ? 'stock-low' : ''}">${stockDisplay}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Cost</div>
                <div class="detail-value">${getCurrencySymbol()}${costPerUnit.toFixed(2)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Profit</div>
                <div class="detail-value" style="color: var(--success);">+${profitMargin}%</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Unit</div>
                <div class="detail-value">${item.unit}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Add to cart
    function addToCart(index) {
      const item = inventory[index];
      if (item.stock <= 0) {
        alert('This product is out of stock!');
        return;
      }
      
      // Find if item already in cart
      const existingItem = cart.find(cartItem => 
        cartItem.name === item.name && cartItem.unit === item.unit
      );
      
      if (existingItem) {
        // Increase quantity by 1
        existingItem.qty += 1;
        // Update stock
        item.stock -= 1;
      } else {
        // Add new item
        cart.push({
          name: item.name,
          basePrice: item.price,
          costPrice: item.costPrice,
          qty: 1,
          unit: item.unit,
          packSize: item.packSize || 1
        });
        item.stock -= 1;
      }
      
      window.shopData.inventory = inventory;
      saveShopData();
      updateCart();

      // 🔥 UPDATE LIVE CART AFTER ADDING ITEM
      updateLiveCart();
    }

    // Update quantity
    function updateQuantity(cartIndex, newQty) {
      const cartItem = cart[cartIndex];
      if (!cartItem) return;

      // Find matching inventory item
      const invItem = inventory.find(p => p.name === cartItem.name && p.unit === cartItem.unit);
      if (!invItem) return;

      const oldQty = cartItem.qty;
      const qtyDiff = oldQty - newQty; // positive = returning stock, negative = taking more

      // Check if new quantity is valid
      if (newQty <= 0) {
        // Remove item if qty <= 0
        invItem.stock += oldQty;
        cart.splice(cartIndex, 1);
      } else {
        // Validate against available stock (including what's already in cart)
        const maxAllowed = invItem.stock + oldQty;
        if (newQty > maxAllowed) {
          alert(`Only ${maxAllowed} ${invItem.unit} available in stock!`);
          updateCart(); // refresh to reset input
          return;
        }
        // Update stock and cart
        invItem.stock += qtyDiff;
        cartItem.qty = newQty;
      }

      window.shopData.inventory = inventory;
      saveShopData();
      updateCart();

      // 🔥 UPDATE LIVE CART AFTER CHANGING QUANTITY
      updateLiveCart();
    }

    // Calculate subtotal
    function calculateSubtotal() {
      let subtotal = 0;
      cart.forEach(item => {
        const pricePerUnit = item.basePrice / (item.packSize || 1);
        subtotal += pricePerUnit * item.qty;
      });
      return subtotal;
    }

    // Apply discount
    function applyDiscount() {
      const discountValue = parseFloat(document.getElementById('discountValue').value);
      const discountType = document.getElementById('discountType').value;
      const subtotal = calculateSubtotal();

      if (isNaN(discountValue) || discountValue <= 0) {
        alert('Please enter a valid discount amount!');
        return;
      }

      let discountAmount = 0;
      if (discountType === 'percent') {
        if (discountValue > 100) {
          alert('Discount cannot be more than 100%!'); 
          return;
        }
        discountAmount = (subtotal * discountValue) / 100;
      } else {
        discountAmount = discountValue;
        if (discountAmount > subtotal) {
          alert('Discount cannot be greater than subtotal!');
          return;
        }
      }

      appliedDiscount = { type: discountType, value: discountValue, amount: discountAmount };
      updateCart();

      // 🔥 UPDATE LIVE CART AFTER APPLYING DISCOUNT
      updateLiveCart();
    }

    // Update cart display
    function updateCart() {
      const cartDiv = document.getElementById('cartItems');
      const countDiv = document.getElementById('cartCount');
      const subtotal = calculateSubtotal();
      let total = subtotal;

      // Apply discount if exists
      if (appliedDiscount) {
        total = Math.max(0, subtotal - appliedDiscount.amount);
      }

      cartDiv.innerHTML = '';
      
      if (cart.length === 0) {
        cartDiv.innerHTML = '<div class="no-results">Add products to your cart</div>';
        document.getElementById('total').innerText = '0.00';
        countDiv.innerText = '0 items';
        appliedDiscount = null; // reset discount
        return;
      }
      
      cart.forEach((item, i) => {
        const pricePerUnit = item.basePrice / (item.packSize || 1);
        const totalPrice = pricePerUnit * item.qty;
        
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div class="item-name">${escapeHtml(item.name)}</div>
          
          <div class="quantity-control">
            <button class="qty-btn" onclick="updateQuantity(${i}, ${Math.max(1, item.qty - 1)})">-</button>
            <input type="number" class="qty-input" value="${item.qty}" min="1" 
                   oninput="updateQuantity(${i}, parseInt(this.value) || 1)" 
                   onchange="updateQuantity(${i}, parseInt(this.value) || 1)">
            <button class="qty-btn" onclick="updateQuantity(${i}, ${item.qty + 1})">+</button>
            <span style="margin-left: 8px; color: var(--gray-600);">${item.unit}</span>
          </div>
          
          <div class="item-details">
            <div class="detail-row">
              <span class="detail-label">Price:</span>
              <span class="detail-value">${getCurrencySymbol()}${totalPrice.toFixed(2)}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Unit Price:</span>
              <span class="detail-value">${getCurrencySymbol()}${pricePerUnit.toFixed(2)}</span>
            </div>
          </div>
          
          <button class="remove-btn" onclick="removeItem(${i})">×</button>
        `;
        cartDiv.appendChild(div);
      });

      // Show discount info if applied
      if (appliedDiscount) {
        const discountDisplay = appliedDiscount.type === 'percent' 
          ? `${appliedDiscount.value}%` 
          : `${getCurrencySymbol()}${appliedDiscount.amount.toFixed(2)}`;
        const discountLabel = document.createElement('div');
        discountLabel.innerHTML = `
          <div style="background:#fef3c7; padding:0.75rem; border-radius:0.75rem; margin-top:1rem; font-weight:600; color:#92400e;">
            Discount Applied: ${discountDisplay}
          </div>
        `;
        cartDiv.appendChild(discountLabel);
      }
      
      document.getElementById('total').innerText = total.toFixed(2);
      document.getElementById('currencySymbol').innerText = getCurrencySymbol();
      countDiv.innerText = `${cart.length} item${cart.length !== 1 ? 's' : ''}`;
    }

    // Remove item
    function removeItem(index) {
      const item = cart[index];
      
      // Find the inventory item and restore stock
      const invItem = inventory.find(p => p.name === item.name && p.unit === item.unit);
      if (invItem) {
        invItem.stock += item.qty;
        window.shopData.inventory = inventory;
        saveShopData();
      }
      
      cart.splice(index, 1);
      updateCart();

      // 🔥 UPDATE LIVE CART AFTER REMOVING ITEM
      updateLiveCart();
    }

    // Set product filter
    function setProductFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      searchProducts();
    }

    // Log sale to reports
    function logSaleToReports(cart, total, paymentMethod, discountInfo = null, customerPhone = '') {
      const saleItems = cart.map(item => {
        const costPerUnit = item.costPrice / (item.packSize || 1);
        const finalQty = item.qty;
        const finalCost = costPerUnit * item.qty;
        
        return {
          name: item.name,
          qty: finalQty,
          price: item.basePrice / (item.packSize || 1),
          cost: costPerUnit,
          total: (item.basePrice / (item.packSize || 1)) * item.qty
        };
      });
      
      const subtotal = saleItems.reduce((sum, item) => sum + item.total, 0);
      const totalCost = saleItems.reduce((sum, item) => sum + (item.cost * item.qty), 0);
      const discountAmount = discountInfo ? discountInfo.amount : 0;
      
      const saleRecord = {
        date: new Date().toISOString(),
        items: saleItems,
        subtotal: subtotal,
        discount: discountAmount,
        totalSales: total,
        totalCost: totalCost,
        profit: total - totalCost,
        paymentMethod: paymentMethod,
        cashier: window.currentUserEmail,
        customerPhone: customerPhone, // 👈 ADDED CUSTOMER PHONE
        discountType: discountInfo ? discountInfo.type : null,
        discountValue: discountInfo ? discountInfo.value : null
      };
      
      let salesLog = window.shopData.salesLog || [];
      salesLog.push(saleRecord);
      window.shopData.salesLog = salesLog;
      saveShopData();
      
      // Add to audit log
      const discountDetails = discountInfo 
        ? `Discount: ${discountInfo.type === 'percent' ? discountInfo.value + '%' : getCurrencySymbol() + discountInfo.amount.toFixed(2)}`
        : '';
      const phoneDetails = customerPhone ? `Phone: ${customerPhone}` : '';
      addAuditLog(window.currentUserEmail, 'add', 'Sale', `Transaction ${saleRecord.date.slice(0,10)}`, 
        `Total: ${getCurrencySymbol()}${total.toFixed(2)} ${discountDetails} ${phoneDetails}`);
    }

    // Process payment
    function processPayment(method) {
      const total = parseFloat(document.getElementById('total').innerText);
      if (total === 0) { alert('Your cart is empty!'); return; }
      
      const customerPhone = document.getElementById('customerPhone').value.trim();
      const momo = window.shopData.momoNumber || '024XXXXXXXX';
      
      if (method === 'MoMo') {
        if (!confirm(`Ask customer to send ${getCurrencySymbol()}${total} to ${momo}\n\nClick OK after payment received.`)) return;
      } else if (method === 'Card') {
        if (!confirm(`Process ${getCurrencySymbol()}${total} on card machine.\n\nClick OK after approval.`)) return;
      }
      
      logSaleToReports(cart, total, method, appliedDiscount, customerPhone);

      // 🔥 CLEAR LIVE CART AFTER SALE COMPLETION
      const liveCart = window.shopData.liveCart || {};
      delete liveCart[liveCartKey];
      window.shopData.liveCart = liveCart;
      saveShopData();

      printReceipt(total, method, appliedDiscount, customerPhone);
    }

    // Print receipt - ONLY the receipt, nothing else
    function printReceipt(total, method, discountInfo = null, customerPhone = '') {
      const shopName = window.shopData.shopName || 'My Shop';
      const currency = getCurrencySymbol();
      const now = new Date().toLocaleString('en-GB', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        timeZone: 'Africa/Accra'
      });
      const transactionId = `JELVIN${Date.now().toString().slice(-6)}`;
      const cashier = window.currentUserEmail;
      const subtotal = calculateSubtotal();

      // Build receipt lines
      let lines = [];
      lines.push(centerText(shopName, 40));
      lines.push(centerText('--- RECEIPT ---', 40));
      lines.push(centerText(now, 40));
      lines.push('='.repeat(40));

      // Add cart items
      cart.forEach(item => {
        const pricePerUnit = item.basePrice / (item.packSize || 1);
        const totalPrice = pricePerUnit * item.qty;
        const desc = `${item.qty} ${item.unit} @ ${currency}${pricePerUnit.toFixed(2)}`;
        
        // Item name (truncate if too long)
        const itemName = item.name.length > 25 ? item.name.substring(0, 24) + '…' : item.name;
        const priceStr = `${currency}${totalPrice.toFixed(2)}`;
        const line = itemName.padEnd(30) + priceStr.padStart(10);
        lines.push(line);
        lines.push('  ' + desc);
      });

      lines.push('-'.repeat(40));
      lines.push('SUBTOTAL:'.padEnd(30) + `${currency}${subtotal.toFixed(2)}`.padStart(10));
      
      // Add discount line if applied
      if (discountInfo) {
        const discountDisplay = discountInfo.type === 'percent' 
          ? `${discountInfo.value}%` 
          : `${currency}${discountInfo.amount.toFixed(2)}`;
        lines.push('DISCOUNT:'.padEnd(30) + `-${discountDisplay}`.padStart(10));
      }
      
      lines.push('TOTAL:'.padEnd(30) + `${currency}${total.toFixed(2)}`.padStart(10));
      if (customerPhone) {
        lines.push('PHONE:'.padEnd(30) + customerPhone.padStart(10));
      }
      lines.push('PAID BY:'.padEnd(30) + method.padStart(10));
      lines.push('CASHIER:'.padEnd(30) + cashier.substring(0, 10).padStart(10));
      lines.push('TXN ID:'.padEnd(30) + transactionId.padStart(10));
      lines.push('='.repeat(40));
      lines.push(centerText('Thank you! Come again.', 40));
      lines.push(centerText('💚', 40));

      const receiptContent = lines.join('\n');

      // Create a hidden iframe for clean printing
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Receipt</title>
          <style>
            body { 
              font-family: 'Courier New', monospace; 
              font-size: 14px; 
              margin: 0; 
              padding: 10px; 
              white-space: pre;
              line-height: 1.4;
            }
            @media print {
              body { 
                margin: 0; 
                padding: 0; 
              }
            }
          </style>
        </head>
        <body>${receiptContent}</body>
        </html>
      `);
      doc.close();

      // Trigger print
      iframe.contentWindow.focus();
      iframe.contentWindow.print();

      // Clean up
      setTimeout(() => {
        document.body.removeChild(iframe);
        cart = [];
        appliedDiscount = null;
        document.getElementById('customerPhone').value = ''; // Clear phone
        updateCart();
      }, 1000);
    }

    // Helper: center text in fixed width
    function centerText(text, width) {
      const padding = Math.max(0, Math.floor((width - text.length) / 2));
      return ' '.repeat(padding) + text;
    }

    // Initialize
    document.getElementById('searchInput').focus();
    searchProducts();
  </script>
</body>
</html>